<style>
/* Offer Management  Styles */
.main-content {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-header h1 {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-color);
}

.add-btn {
  background-color: var(--primary-color);
  color: white;
  padding: 8px 15px;
  border-radius: 5px;
  font-weight: 600;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.3s ease;
}

.add-btn:hover {
  background-color: #ff9933;
}

/* Search and Sort Bar */
.search-sort-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
}

.search-sort-bar input {
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 8px 12px;
  border-radius: 5px;
  width: 280px;
  outline: none;
}

.search-sort-bar select {
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 8px 12px;
  border-radius: 5px;
  outline: none;
  cursor: pointer;
}

/* Table Styling */
.table-container {
  background-color: var(--card-bg);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

.admin-table th,
.admin-table td {
  padding: 15px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.admin-table th {
  background-color: rgba(255, 140, 0, 0.1);
  color: var(--primary-color);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}

.admin-table tbody tr:hover {
  background-color: rgba(255, 140, 0, 0.05);
}

.admin-table tbody tr:last-child td {
  border-bottom: none;
}

/* Status Badges */
.user-status {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.status-active {
  background-color: rgba(72, 187, 120, 0.2);
  color: var(--success-color);
}

.status-blocked {
  background-color: rgba(245, 101, 101, 0.2);
  color: var(--danger-color);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 10px;
}

.toggle-status-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.3s ease;
  background-color: rgba(245, 101, 101, 0.2);
  color: var(--danger-color);
}

.toggle-status-btn:hover {
  background-color: var(--danger-color);
  color: white;
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  gap: 10px;
}

.pagination-btn {
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
  background-color: var(--primary-color);
  color: white;
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#page-numbers {
  display: flex;
  gap: 5px;
}

.page-number {
  width: 35px;
  height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.page-number:hover {
  background-color: rgba(255, 140, 0, 0.1);
  color: var(--primary-color);
}

.page-number.active {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* Edit Offer Button */
.edit-offer-btn {
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 7px 14px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.edit-offer-btn i {
  font-size: 13px;
}

.edit-offer-btn:hover {
  background-color: #0056b3;
  transform: translateY(-2px);
}


/* Responsive */
@media (max-width: 1024px) {
  .search-sort-bar {
    flex-direction: column;
    align-items: flex-start;
  }

  .search-sort-bar input,
  .search-sort-bar select {
    width: 100%;
  }
}

@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;
  }

  .pagination {
    flex-wrap: wrap;
  }
}
</style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <%-include("../../Views/Partials/Admin/header")%>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="main-content">
    <div class="page-header">
      <h1>Offer Management</h1>
      <a href="/admin/addOffer" class="btn add-btn">
        <i class="fas fa-plus"></i> Add New Offer
      </a>
    </div>

    <div class="search-sort-bar">
      <input type="text" id="offer-search" placeholder="Search offers..." />
      <select id="sort-select">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="name-asc">Name A-Z</option>
        <option value="name-desc">Name Z-A</option>
      </select>
    </div>

    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>SL</th>
            <th>Offer Name</th>
            <th>Type</th>
            <th>Discount (%)</th>
            <th>Applicable To</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="offers-table-body"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prev-page" class="pagination-btn">Prev</button>
      <div id="page-numbers"></div>
      <button id="next-page" class="pagination-btn">Next</button>
    </div>
  </div>

  <script>
    document.addEventListener("click", function (event) {
      const editButton = event.target.closest(".edit-offer-btn");
      if (editButton) {
        const offerId = editButton.getAttribute("data-id");
        if (offerId) {
          window.location.href = `/admin/editOffer/${offerId}`;
        }
      }
    });

    document.addEventListener("DOMContentLoaded", function () {

      let offers = <%- JSON.stringify(offerData) %>;
      offers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      let currentPage = 1;
      const offersPerPage = 5;
      let filteredOffers = [...offers];

      function formatDate(dateString) {
        if (!dateString) return "-";
        const options = { year: "numeric", month: "short", day: "numeric" };
        return new Date(dateString).toLocaleDateString("en-US", options);
      }

      function renderOffers() {
        const tableBody = document.getElementById("offers-table-body");
        tableBody.innerHTML = "";

        const startIndex = (currentPage - 1) * offersPerPage;
        const endIndex = startIndex + offersPerPage;
        const paginatedOffers = filteredOffers.slice(startIndex, endIndex);

        paginatedOffers.forEach((offer, index) => {
          const row = document.createElement("tr");
          const slNo = startIndex + index + 1;

        const applicableNames = offer.ApplicableTo?.length ? offer.ApplicableTo
                                     .map(item => item.productName || item.name || item.brandName || "-")
                                     .join(", "): "-";

          row.innerHTML = `
            <td>${slNo}</td>
            <td>${offer.offerName}</td>
            <td>${offer.offerType}</td>
            <td>${offer.discountPercentage}%</td>
            <td>${applicableNames}</td>
            <td>${formatDate(offer.startDate)}</td>
            <td>${formatDate(offer.endDate)}</td>
            <td>
              <span class="user-status ${offer.status ? "status-active" : "status-blocked"}">
                ${offer.status ? "Active" : "Inactive"}
              </span>
            </td>
            <td class="action-buttons">
          
              <button class="edit-offer-btn" data-id="${offer._id}">
                <i class="fas fa-edit"></i> Edit
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });

        document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const offerId = this.getAttribute("data-id");
            const currentStatus = this.getAttribute("data-status") === "true";
            toggleOfferStatus(offerId, !currentStatus);
          });
        });

        updatePagination();
      }

      async function toggleOfferStatus(offerId, newStatus) {
        const result = await Swal.fire({
          title: "Are you sure?",
          text: `Do you want to ${newStatus ? "activate" : "deactivate"} this offer?`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          const res = await fetch(`/admin/toggleOfferStatus/${offerId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus }),
          });

          const data = await res.json();

          if (data.success) {
            Swal.fire("Updated!", data.message, "success");
            const offer = offers.find(o => o._id === offerId);
            if (offer) offer.status = newStatus;
            renderOffers();
          } else {
            Swal.fire("Error", data.message, "error");
          }
        } catch (error) {
          Swal.fire("Error", "Something went wrong!", "error");
        }
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredOffers.length / offersPerPage);
        const pageNumbers = document.getElementById("page-numbers");
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");

        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;

        pageNumbers.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.className = `page-number ${i === currentPage ? "active" : ""}`;
          btn.textContent = i;
          btn.addEventListener("click", () => {
            currentPage = i;
            renderOffers();
          });
          pageNumbers.appendChild(btn);
        }
      }

      // Search
      const searchInput = document.getElementById("offer-search");
      searchInput.addEventListener("input", function () {
        const term = this.value.toLowerCase().trim();
        filteredOffers = offers.filter((offer) =>
          offer.offerName.toLowerCase().includes(term)
        );
        currentPage = 1;
        renderOffers();
      });

      // Sort
      const sortSelect = document.getElementById("sort-select");
      sortSelect.addEventListener("change", function () {
        const value = this.value;
        switch (value) {
          case "newest":
            filteredOffers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            break;
          case "oldest":
            filteredOffers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            break;
          case "name-asc":
            filteredOffers.sort((a, b) => a.offerName.localeCompare(b.offerName));
            break;
          case "name-desc":
            filteredOffers.sort((a, b) => b.offerName.localeCompare(a.offerName));
            break;
        }
        renderOffers();
      });

      document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderOffers();
        }
      });

      document.getElementById("next-page").addEventListener("click", () => {
        const totalPages = Math.ceil(filteredOffers.length / offersPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderOffers();
        }
      });

      renderOffers();
          
    });
    
  document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const offerId = btn.getAttribute("data-id");
      const isActive = btn.getAttribute("data-status") === "true";
  
      const result = await Swal.fire({
        title: isActive
          ? "Deactivate this offer?"
          : "Activate this offer?",
        text: isActive
          ? "This offer will be deactivated and will no longer be applied."
          : "This offer will be activated and applied again.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: isActive ? "#d33" : "#3085d6",
        cancelButtonColor: "#aaa",
        confirmButtonText: isActive ? "Yes, deactivate it!" : "Yes, activate it!",
      });
  
      if (!result.isConfirmed) return;
  
      try {
        const res = await fetch(`/admin/toggleOfferStatus/${offerId}`, {
          method: "PUT",
        });
        const data = await res.json();
  
        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Success",
            text: data.message,
            confirmButtonColor: "#3085d6",
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message,
          });
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Server Error",
          text: "Something went wrong while updating offer status.",
        });
      }
    });
  });
  </script>
</body>
</html>
