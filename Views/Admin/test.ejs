<!-- //  --------------updated with some scenario-------------

// export const addOffer = async (req, res, next) => {
//   try {
//     const { offerName, offerType, ApplicableTo, discountPercentage, startDate, endDate } = req.body;

//     // Basic input validation
//     if (!offerName || !offerType || !ApplicableTo?.length || !discountPercentage || !startDate || !endDate) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "All fields are required.",
//       });
//     }

//     if (discountPercentage <= 0 || discountPercentage > 100) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "Discount must be between 1 and 100%.",
//       });
//     }

//     // Check if offer name already exists
//     const existingName = await offerSchema.findOne({ offerName: { $regex: new RegExp(`^${offerName}$`, "i") } });
//     if (existingName) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "An offer with this name already exists.",
//       });
//     }

//     // Check for existing active offers on same products/categories/brands
//     const overlappingOffers = await offerSchema.find({
//       offerType,
//       ApplicableTo: { $in: ApplicableTo },
//       status: true,
//       $or: [
//         {
//           startDate: { $lte: new Date(endDate) },
//           endDate: { $gte: new Date(startDate) },
//         },
//       ],
//     });

//     if (overlappingOffers.length > 0) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "One or more selected items already have an active offer in this date range.",
//       });
//     }

//     // Create new offer
//     const newOffer = new offerSchema({
//       offerName,
//       offerType,
//       ApplicableTo,
//       discountPercentage,
//       startDate,
//       endDate,
//       status: true,
//     });

//     await newOffer.save();

//     return res.status(STATUS.OK).json({
//       success: true,
//       message: "Offer added successfully!",
//       offer: newOffer,
//     });
//   } catch (error) {
//     console.error("Error while adding offer:", error);
//     next(error);
//   }
// }; -->


// -------------- add offers-------
// export const addOffer = async (req, res, next) => {
//    console.log("addOffer controller called..........")
//   try {
//     const {
//       offerName,
//       offerType,
//       discountPercentage,
//       ApplicableTo,
//       startDate,
//       endDate,
//     } = req.body;

//     console.log("req.body in addOffer:::", req.body);

//     // 1. Basic validation
//     if (
//       !offerName ||
//       !offerType ||
//       !discountPercentage ||
//       !ApplicableTo ||
//       !startDate ||
//       !endDate
//     ) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "All fields are required",
//       });
//     }

//     //  2. Validate offerType
//     const validTypes = ["product", "category", "brand"];

//     if (!validTypes.includes(offerType.toLowerCase())) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "Invalid offer type",
//       });
//     }

//     //  5. Create and save offer
//     const newOffer = new offerSchema({
//       offerName,
//       offerType,
//       discountPercentage,
//       ApplicableTo,
//       startDate,
//       endDate,
//     });
//      console.log( "new offer::", newOffer)

//     await newOffer.save();

//     //  6. Send success response
//     return res.status(STATUS.CREATED).json({
//       success: true,
//       message: MESSAGES.Offers.ADD_SUCCESS || "Offer added successfully",
//       offer: newOffer,
//     });

//   } catch (error) {
//     console.error(MESSAGES.Offers.ADD_ERROR || "Offer creation failed", error);
//     next(error);
//   }
// };


// export const addOffer = async (req, res, next) => {
//   console.log("addOffer controller started...");

//   try {
//     const {
//       offerName,
//       offerType,
//       discountPercentage,
//       ApplicableTo,
//       startDate,
//       endDate,
//     } = req.body;

//     // üß© Step 1: Basic validation
//     if (
//       !offerName ||
//       !offerType ||
//       !discountPercentage ||
//       !ApplicableTo?.length ||
//       !startDate ||
//       !endDate
//     ) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "All fields are required",
//       });
//     }

//     const validTypes = ["Product", "Category", "Brand"];
//     if (!validTypes.includes(offerType)) {
//       return res.status(STATUS.BAD_REQUEST).json({
//         success: false,
//         message: "Invalid offer type",
//       });
//     }

//     // üß© Step 2: Save the offer first
//     const newOffer = new offerSchema({
//       offerName,
//       offerType,
//       discountPercentage,
//       ApplicableTo,
//       startDate,
//       endDate,
//     });

//     await newOffer.save();
//     console.log("‚úÖ Offer saved successfully:", newOffer._id);

//     // üß© Step 3: Find affected products
//     let productsToUpdate = [];

//     if (offerType === "Product") {
//       productsToUpdate = await productSchema.find({ _id: { $in: ApplicableTo } });
//     } else if (offerType === "Brand") {
//       productsToUpdate = await productSchema.find({ brand: { $in: ApplicableTo } });
//     } else if (offerType === "Category") {
//       productsToUpdate = await productSchema.find({ category: { $in: ApplicableTo } });
//     }

//     console.log(`üõ† Found ${productsToUpdate.length} products to update`);

//     // üß© Step 4: For each product, determine the best applicable offer
//     for (const product of productsToUpdate) {
//       const productId = product._id;

//       // Fetch all offers related to this product (product, brand, category)
//       const relatedOffers = await offerSchema.find({
//         $or: [
//           { offerType: "Product", ApplicableTo: productId },
//           { offerType: "Brand", ApplicableTo: product.brand },
//           { offerType: "Category", ApplicableTo: product.category },
//         ],
//         status: true,
//       });

//       // Get the maximum discount among all applicable offers
//       const bestOffer =
//         relatedOffers.length > 0
//           ? Math.max(...relatedOffers.map((o) => o.discountPercentage))
//           : 0;

//       // Update only if a valid offer exists
//       if (bestOffer > 0) {
//         product.productOffer = bestOffer;

//         // Update offer price for each variant
//         product.variants = product.variants.map((variant) => {
//           const calculatedOfferPrice = Math.round(
//             variant.salePrice - (variant.salePrice * bestOffer) / 100
//           );
//           return { ...variant, offerPrice: calculatedOfferPrice };
//         });

//         await product.save();
//         console.log(`üí∞ Applied ${bestOffer}% offer to: ${product.productName}`);
//       }
//     }

//     // üß© Step 5: Response
//     return res.status(STATUS.CREATED).json({
//       success: true,
//       message: MESSAGES?.Offers?.ADD_SUCCESS || "Offer added successfully",
//       offer: newOffer,
//       updatedProducts: productsToUpdate.length,
//     });
//   } catch (error) {
//     console.error("‚ùå Error in addOffer controller:", error);
//     next(error);
//   }
// };
