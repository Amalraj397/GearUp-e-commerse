<head>

  <title>AutoMinima - precesion in every scale</title>
  <meta name="author" content="p-themes">
  <link rel="apple-touch-icon" sizes="180x180" href="/User/assets/images/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/User/assets/images/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/User/assets/images/icons/favicon-16x16.png">
  <link rel="manifest" href="/User/assets/images/icons/site.html">
  <link rel="mask-icon" href="/User/assets/images/icons/safari-pinned-tab.svg" color="#666666">
  <link rel="shortcut icon" href="/User/assets/images/icons/autominima-logo.png">
  <meta name="apple-mobile-web-app-title" content="Molla">
  <meta name="application-name" content="Molla">
  <meta name="msapplication-TileColor" content="#cc9966">
  <meta name="msapplication-config" content="/User/assets-/images/icons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="/User/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="/User/assets/css/style.css">
  <link rel="stylesheet" href="/User/assets/css/plugins/owl-carousel/owl.carousel.css">
  <link rel="stylesheet" href="/User/assets/css/plugins/magnific-popup/magnific-popup.css">
  <link rel="stylesheet" href="/User/assets/css/plugins/nouislider/nouislider.css">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Bebas+Neue&family=Orbitron&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    .clear-btn {
      padding: 7px 4px;
      background-color: #ffffff;
      border-radius: 0 4px 4px 0;
      color: black;
      cursor: pointer;
      position: absolute;
      right: 41%;
      top: 27px;
      transform: translateY(-50%);
      /* color: #fffbfb; */
      font-size: 16px;
      transition: color 0.2s ease;
    }

    .search-btn:hover {
      color: rgb(0, 145, 255);
    }
    .clear-btn:hover {
      color: #ff0000;
    }
    .reloadShop_btn{
      /* margin-top: 50px; */
      margin-right: 30px;
      display: block;
      border: 1px solid;
      padding: 8px;
      border-radius:3px;
    }

  </style>

  <%-include("../../Views/Partials/User/headerLand")%>
</head>

<body>
  <div class="page-wrapper">
    <!-- header -->
    <main class="main">
      <div class="page-header text-center" style="background-image: url('/User/assets/images/2025-Ferrari-499P-001-1440w.jpg' ); margin-top: 55px;">
        <div class="container">
          <h1 class="page-title">Collect all your faviourate items starting from 199/-<span>Shop now</span></h1>
        </div><!-- End .container -->
      </div><!-- End .page-header -->
        <div class="page-content">
          <div class="container">
            <div class="row">
              <div class="col-lg-9 product-list">
                <div class="search-box">
                  <input type="text" id="product-search" placeholder="Search productshere..." value="<%= searchQuery || '' %>" />
                  <button class="search-btn">
                    <i class="fas fa-search"></i>
                  </button>
                  <button class="clear-btn" id="clear-search" title="Clear search">
                    <i class="fas fa-times"></i> clear
                  </button>    
                </div>
                <div class="toolbox">
                  <div class="toolbox-left">
                    <div class="toolbox-info">
                      <!-- Showing <span>9 of 56</span> Products -->
                    </div><!-- End .toolbox-info -->
                  </div><!-- End .toolbox-left -->
                 </div>
                <div class="products mb-3">
              <div class="row g-4 justify-content-center" id="product-list">
                <% if (products.length === 0) { %>
                  <p style="font-size:x-large;">No products found. -></p>
                  <a href="/shopPage" class="reloadShop_btn"><span>Reload Shop</span></a>
                <% } else { %>
                  <% products.forEach(product => { 
                       const variant = product.variants && product.variants.length > 0 ? product.variants[0] : null;
                       const hasOffer = product.productOffer > 0 && variant?.offerPrice > 0;
                  %>
                    <div class="col-md-6 col-lg-4 col-xl-3">
                      <div class="products-container position-relative">
            
            
                    <!-- Wishlist Icon -->
                    <i 
                      class="wishlist-icon fa-solid fa-heart position-absolute" 
                      style="top: 10px; right: 10px; font-size: 22px; cursor: pointer; color: <%= userWishlist && userWishlist.includes(product._id.toString()) ? 'red' : '#d9d3d2' %>;"
                      onclick="toggleWishlist('<%= product._id %>', this)">
                    </i>
            
                    <!-- Offer Badge -->
            
                    <% if (hasOffer) { %>
                      <div class="offer-badge position-absolute text-white fw-bold rounded px-2 py-1"
                        style="bottom:196px;left:178px;font-size:12px;font-family:'Orbitron';font-weight:600;background-color:#ff0000;">
                        <%= product.productOffer %>%  OFF
                      </div>
                    <% } %>
            
                    <a href="/productDetail/<%=product._id%>">
                      <div class="product-card">
                        <img src="<%= product.productImage[0] %>" class="img-fluid w-100 rounded-top" alt="<%= product.productName %>">
                      </div>
                      <div class="text-white bg-secondary px-3 py-1 rounded position-absolute" style="top: 13px; left: 10px;">
                        <%= product.category ? product.category.name : 'Cat_Autominima' %>
                      </div>
                      <div class="p-4 border border-secondary border-top-0 rounded-bottom">
                        <h4><%= product.productName.slice(0,22)%>...</h4>
                        <p>
                          <%= variant ? variant.scale : 'No scale' %> | <%= product.edition %>
                        </p>
            
                        <div class="d-flex justify-content-between flex-lg-wrap align-items-center">
                          <% if (hasOffer) { %>
                            <div>
                              <p class="text-muted mb-0" style="text-decoration: line-through; font-size: 14px;">
                                ₹<%= variant.salePrice %>
                              </p>
                              <p class="text-success fs-5 fw-bold mb-0">
                                ₹<%= variant.offerPrice %>
                              </p>
                            </div>
                          <% } else { %>
                            <p class="text-dark fs-5 fw-bold mb-0">
                              ₹<%= variant ? variant.salePrice : 'N/A' %>
                            </p>
                          <% } %>
            
                          <a href="#" class="btn border border-secondary text-primary" onclick="addToWishlist('<%= product._id %>')">❤️ wishlist</a>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
              <% }) %>
            <% } %>
            </div>
            </div>

                <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center">

                    <% if (currentPage > 1) { %>
                    <li class="page-item">
                      <a class="page-link page-link-prev" href="?page=<%= currentPage - 1 %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" aria-label="Previous">
                        <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Prev
                      </a>
                    </li>
                    <% } else { %>
                    <li class="page-item disabled">
                      <a class="page-link page-link-prev" href="#" tabindex="-1" aria-disabled="true">
                        <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Prev
                      </a>
                    </li>
                    <% } %>

                    <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link" href="?page=<%= i %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>

                    <li class="page-item-total">of <%= totalPages %></li>

                    <% if (currentPage < totalPages) { %>
                    <li class="page-item">
                      <a class="page-link page-link-next" href="?page=<%= currentPage + 1 %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" aria-label="Next">
                        Next <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                      </a>
                    </li>
                    <% } else { %>
                    <li class="page-item disabled">
                      <a class="page-link page-link-next" href="#" tabindex="-1" aria-disabled="true">
                        Next <span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                      </a>
                    </li>
                    <% } %>
                  </ul>
                </nav>
              </div><!-- End .col-lg-9 -->
              <aside class="col-lg-3 order-lg-first">
                <div class="sidebar sidebar-shop">
                  <div class="widget widget-clean">
                    <label>Filters:</label>
                    <a href="/shopPage" class="btn btn-outline-primary-2">Clear All</a>
                  </div><!-- End .widget widget-clean -->
                  <!-- Filter by Category -->
                  <div class="widget widget-categories">
                    <h3 class="widget-title">Filter by Category</h3>
                    <div class="filter-items" id="category-filter">
                      <% categories.forEach(category => { %>
                      <label>
                        <input type="checkbox" class="category-checkbox" value="<%= category._id %>">
                        <%= category.name %>
                      </label>
                      <% }) %>
                    </div>
                  </div>
                  <!-- Filter by Brand -->
                  <div class="widget widget-categories">
                    <h3 class="widget-title">Filter by Brand</h3>
                    <div class="filter-items" id="brand-filter">
                      <% brands.forEach(brand => { %>
                      <label>
                        <input type="checkbox" class="brand-checkbox" value="<%= brand._id %>">
                        <%= brand.brandName%>
                      </label>
                      <% }) %>
                    </div>
                  </div>

                  <!-- Filter by Edition -->
                  <div class="widget widget-categories">
                    <h3 class="widget-title">Filter by Edition</h3>
                    <div class="filter-items" id="edition-filter">
                      <% editions.forEach(edition => { %>
                      <% if (edition) { %>
                      <label>
                        <input type="checkbox" class="edition-checkbox" value="<%= edition %>">
                        <%= edition %>
                      </label>
                      <% } %>
                      <% }) %>
                    </div>
                  </div>

                  <!-- Filter by Scale -->
                  <div class="widget widget-categories">
                    <h3 class="widget-title">Filter by Scale</h3>
                    <div class="filter-items" id="scale-filter">
                      <% scales.forEach(scale => { %>
                      <label>
                        <input type="checkbox" class="scale-checkbox" value="<%= scale %>">
                        <%= scale %>
                      </label>
                      <% }) %>
                    </div>
                  </div>
                </div><!-- End .widget -->
                <!-- <div class="widget widget-collapsible"> -->
                <h3 class="widget-title">
                  <a data-toggle="collapse" href="#widget-5" role="button" aria-expanded="true" aria-controls="widget-5">
                    Price
                  </a>
                </h3><!-- End .widget-title -->

                <div class="widget-body">
                  <div class="filter-price">
                    <div class="filter-price-text">
                      Price Range : <span id="filter-price-range">₹199 - ₹99999</span>
                    </div><!-- End .filter-price-text -->
                    <div id="price-slider"></div><!-- End #price-slider -->
                  </div><!-- End .filter-price -->

                  <!--  Sort by price dropdown -->
              <div class="filter-sort mt-3">
                <label for="sort-order" class="filter-sort-label">Sort by:</label>
                <select id="sort-order" class="filter-sort-select">
                  <option value="default">Default</option>
                  <option value="asc">Price: Low to High</option>
                  <option value="desc">Price: High to Low</option>
                </select>
              </div>

                </div><!-- End .widget-body -->

                <button id="apply-filters" class="btn btn-primary mt-3">Apply Filters</button>

            </div><!-- End .collapse -->
          </div><!-- End .widget -->
        </div><!-- End .sidebar sidebar-shop -->
    </aside><!-- End .col-lg-3 -->
  </div><!-- End .row -->
  </div><!-- End .container -->
  </div><!-- End .page-content -->
  </main><!-- End .main -->

  </div><!-- End .page-wrapper -->
  <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/jquery.hoverIntent.min.js"></script>
  <script src="assets/js/jquery.waypoints.min.js"></script>
  <script src="assets/js/superfish.min.js"></script>
  <script src="assets/js/owl.carousel.min.js"></script>
  <script src="assets/js/wNumb.js"></script>
  <script src="assets/js/bootstrap-input-spinner.js"></script>
  <script src="assets/js/jquery.magnific-popup.min.js"></script>
  <script src="assets/js/nouislider.min.js"></script>
  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.0/nouislider.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  
  <script>
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const applyBtn = document.getElementById('apply-filters');

    // Price slider setup
    const priceSlider = document.getElementById('price-slider');
    const priceRangeText = document.getElementById('filter-price-range');

    noUiSlider.create(priceSlider, {
      start: [199, 19999],
      connect: true,
      range: {
        min: 199,
        max: 19999
      },
      tooltips: [true, true],
      format: {
        to: val => Math.round(val),
        from: val => Number(val)
      }
    });

    priceSlider.noUiSlider.on('update', function(values) {
      priceRangeText.textContent = `₹${values[0]} - ₹${values[1]}`;
    });

    applyBtn.addEventListener('click', applyFilters);

      function applyFilters() {
        const selectedCategories = getSelectedValues('.category-checkbox');
        const selectedBrands = getSelectedValues('.brand-checkbox');
        const selectedEditions = getSelectedValues('.edition-checkbox');
        const selectedScales = getSelectedValues('.scale-checkbox');
        const [minPrice, maxPrice] = priceSlider.noUiSlider.get();
        const sortOrder = document.getElementById('sort-order').value;
        
        const query = new URLSearchParams();
          
        if (selectedCategories.length) query.append('categories', selectedCategories.join(','));
        if (selectedBrands.length) query.append('brands', selectedBrands.join(','));
        if (selectedEditions.length) query.append('editions', selectedEditions.join(','));
        if (selectedScales.length) query.append('scales', selectedScales.join(','));
        if (minPrice && maxPrice) 
        {
          query.append('minPrice', Math.round(minPrice));
          query.append('maxPrice', Math.round(maxPrice));
        }
        if (sortOrder && sortOrder !== "default") query.append('sort', sortOrder); 
      
          window.location.href = `/filterProducts?${query.toString()}`;
      }
  

    function getSelectedValues(selector) {
      return Array.from(document.querySelectorAll(selector))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    }

    // Search and clear
    const searchInput = document.getElementById('product-search');
    const searchBtn = document.querySelector('.search-btn');
    const clearBtn = document.getElementById('clear-search');

    // Search 
    searchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      const url = new URL(window.location.href);
      url.searchParams.set('search', query);
      url.searchParams.set('page', 1);
      window.location.href = url.toString();
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchBtn.click();
    });

    // Clear 
    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      searchInput.value = '';
      clearBtn.style.display = 'none';
      const url = new URL(window.location.href);
      url.searchParams.delete('search');
      url.searchParams.set('page', 1);
      window.location.href = url.toString();
    });

    if (searchInput.value.trim()) {
      clearBtn.style.display = 'block';
    }

    //stay Sort + Checkbox Selections After Reload
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
    
      //stay sort dropdown selection
      const sortSelect = document.getElementById('sort-order');
      const currentSort = urlParams.get('sort');
      if (currentSort) {
        sortSelect.value = currentSort;
      }
    
      //stay checkbox selections
      const setChecked = (selector, values) => {
        if (!values) return;
        const selectedValues = values.split(",");
        document.querySelectorAll(selector).forEach(cb => {
          if (selectedValues.includes(cb.value)) cb.checked = true;
        });
      };
    
      setChecked('.category-checkbox', urlParams.get('categories'));
      setChecked('.brand-checkbox', urlParams.get('brands'));
      setChecked('.edition-checkbox', urlParams.get('editions'));
      setChecked('.scale-checkbox', urlParams.get('scales'));
    
      //stay price slider range
      const minPrice = urlParams.get('minPrice');
      const maxPrice = urlParams.get('maxPrice');
      if (minPrice && maxPrice) {
        priceSlider.noUiSlider.set([+minPrice, +maxPrice]);
      }
    });

    function addToWishlist(productId) {
        fetch("/addToWishlist", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ productId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                Toastify({
                    text: "Product Added to wishlist ❤",
                    gravity: "top",
                    position: "right",
                    duration: 1000,
                    backgroundColor: "green"
                }).showToast();
                 window.location.reload();
            } else {
                Swal.fire("Oops!", data.message || "Unable to add to wishlist", "error");
            }
        })
        .catch(() => {
            Swal.fire("Error", "Something went wrong!", "error");
        });
    }
  </script>

  <%-include("../../Views/Partials/User/footerLand")%>
</body>

</html>