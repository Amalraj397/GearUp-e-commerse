<%- include("../../Views/Partials/User/headerLand") %>

<head>
    <link rel="stylesheet" href="/User/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/User/assets/css/style.css">
</head>


<body>
    <div class="page-wrapper">
        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Checkout<span></span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shopPage">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="checkout">
	                <div class="container">
            			<form action="#">
		                	<div class="row">
		                		<div class="col-lg-9">
		                			<h1 class="checkout-title">Billing Details</h1><!-- End .checkout-title -->
		                				<div class="row">
		                					<div class="col-sm-6">
		                						<label>First Name *</label>
		                						<input type="text" name ="firstName" class="form-control" 
												value="<%= defaultAddress ? defaultAddress.firstName : '' %>" required>
		                					</div>

		                					<div class="col-sm-6">
		                						<label>Last Name *</label>
		                						<input type="text" name="lastName" class="form-control" 
												value = "<%= defaultAddress ? defaultAddress.lastName : '' %>" required>
		                					</div>
		                				</div>

	            						<label>Email ID:</label>
	            						<input type="email" name="email" class="form-control"
										value=" <%= defaultAddress ? defaultAddress.email : '' %>">

	            						<label>Full Address</label>
	            						<!-- <input type="text" class="form-control" required> -->
										<textarea class="form-control" cols="15" rows="2" 
										placeholder="your full address will be  here "
										readonly name="fullAddress"> <%= defaultAddress ? `${defaultAddress.firstName} ${defaultAddress.lastName}
${defaultAddress.houseName} 
,${defaultAddress.city}, ${defaultAddress.state},${defaultAddress.country} - ${defaultAddress.pincode},
Landmark: ${defaultAddress.landmark}
Type: ${defaultAddress.addressType} ` : '' %></textarea>

		                				<div class="row"></div>	                					
										
                                        <!-- <button type="button" class="btn btn-outline-primary-2 btn-order" data-bs-toggle="modal" data-bs-target="#addressModal">Change Address</button> -->
										<button type="button" class="btn btn-outline-primary-2 btn-order" data-bs-toggle="modal" data-bs-target="#changeAddressModal">
										  Change Address
										</button>
										<button type="submit" class="btn btn-outline-primary-2 btn-order "> ADD NEW ADDRESS</button>

		                		</div><!-- End .col-lg-9 -->
		                		<aside class="col-lg-3">
		                			<div class="summary">
		                				<h3 class="summary-title">Your Orders</h3><!-- End .summary-title -->

                                        <div class="order-section">
                                                <!-- <h2>Your Orders</h2> -->

                                                <div class="order-summary">
                                                    <div class="order-header">
                                                        <span class="col-product">Product</span>
                                                        <span class="col-qty">Qty</span>
                                                        <!-- <span></span> -->
                                                        <span class="col-total">. Total</span>
                                                    </div>
                                                
                                                    <div class="order-items">
                                                        <% cart.items.forEach(item => { %>
                                                            <div class="order-item">
                                                                <span class="product-name">
                                                                    <%= item.productId.productName.split("").slice(0,25).join("") %> ,(<%= item.scale %>)
                                                                </span>
                                                                <span class="product-qty">
                                                                    <%= item.quantity %>
                                                                </span>
                                                                <span class="product-price">
                                                                    ₹<%= (item.salePrice * item.quantity).toFixed(2) %>
                                                                </span>
                                                            </div>
                                                        <% }) %>
                                                    </div>
                                                
                                                    <div class="order-totals">
                                                        <div class="total-row">
                                                            <span>Subtotal:</span>
                                                            <span>₹<%= grandTotal.toFixed(2) %></span>
                                                        </div>
                                                        <div class="total-row">
                                                            <span>Shipping:</span>
                                                            <span>Free shipping</span>
                                                        </div>
														<div>
															 <span><%= grandTotal >= 999 ? "COD Available" : "COD not-Available" %></span>
														</div>
                                                        <div class="total-row total-final">
                                                            <span>Total:</span>
                                                            <span>₹<%= grandTotal.toFixed(2) %></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
		                				<button type="submit" class="btn btn-outline-primary-2 btn-order btn-block" id="placeOrderBtn">Place Order</button>
										<button type="submit" class="btn btn-outline-primary-2 btn-cancel btn-block" id="cancelOrderBtn">Cancel Order</button>
		                			</div><!-- End .summary -->
		                		</aside><!-- End .col-lg-3 -->
		                	</div><!-- End .row -->
            			</form>
	                </div><!-- End .container -->
                </div><!-- End .checkout -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
    </div><!-- End .page-wrapper -->

	<!-- Change Address Modal -->
		<div class="modal fade" id="changeAddressModal" tabindex="-1" aria-hidden="true">
		  <div class="modal-dialog modal-lg">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title">Select Address</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		      </div>
		      <div class="modal-body">
		        <% if (addressData && addressData.length > 0) { %>
		          <form id="addressSelectForm">
		            <% addressData.forEach((address, index) => { %>
		              <div class="border p-2 mb-2">
		                <input type="radio" name="selectedAddress" value="<%= address._id %>" id="addr<%= index %>" <%= defaultAddress && defaultAddress._id.toString() === address._id.toString() ? 'checked' : '' %> >
		                <label for="addr<%= index %>">
		                  <strong><%= address.firstName %> <%= address.lastName %></strong><br>
		                  <%= address.houseName %>, <%= address.city %>, <%= address.state %>, <%= address.country %> - <%= address.pincode %><br>
		                  Landmark: <%= address.landmark %> <br>
		                  Type: <%= address.addressType %>
		                </label>
		              </div>
		            <% }) %>
		          </form>
		        <% } else { %>
		          <p>No saved addresses. Please add one.</p>
		        <% } %>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
		        <button type="button" id="confirmAddressChange" class="btn btn-primary">Continue</button>
		      </div>
		    </div>
		  </div>
		</div>
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>
	
    <!-- Plugins JS File -->
    <script src="/User/assets/js/jquery.min.js"></script>
    <script src="/User/assets/js/bootstrap.bundle.min.js"></script>
    <script src="/User/assets/js/jquery.hoverIntent.min.js"></script>
    <script src="/User/assets/js/jquery.waypoints.min.js"></script>
    <script src="/User/assets/js/superfish.min.js"></script>
    <script src="/User/assets/js/owl.carousel.min.js"></script>
    <!-- Main JS File -->
    <script src="/User/assets/js/main.js"></script>

<script>

	document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("changeAddressBtn").addEventListener("click", () => {
        const modal = new bootstrap.Modal(document.getElementById("changeAddressModal"));
        modal.show();
    });
});

document.getElementById('confirmAddressChange').addEventListener('click', function() {
    const selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked');
	console.log( "modal is working")
    if (!selectedAddressId) {
        alert("Please select an address.");
        return;
    }

    fetch(`/getAddressById/${selectedAddressId.value}`)
        .then(res => res.json())
        .then(address => {
            document.querySelector('input[name="firstName"]').value = address.firstName;
            document.querySelector('input[name="lastName"]').value = address.lastName;
            document.querySelector('input[name="email"]').value = address.email;
            document.querySelector('textarea[name="fullAddress"]').value = 
                `${address.firstName} ${address.lastName}
				${address.houseName}, ${address.city}, ${address.state}, ${address.country} - ${address.pincode}
				Landmark: ${address.landmark}
				Type: ${address.addressType}`;
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('changeAddressModal')).hide();
        })
        .catch(err => console.error(err));
});
</script>

<script>
document.getElementById("placeOrderBtn").addEventListener("click", async (e) => {
  e.preventDefault();

  const orderData = {
    name: document.querySelector('input[name="firstName"]').value + " " + document.querySelector('input[name="lastName"]').value,
    address: document.querySelector('textarea[name="fullAddress"]').value,
    city: document.querySelector('input[name="city"]')?.value || "Unknown",
    state: document.querySelector('input[name="state"]')?.value || "Unknown",
    country: document.querySelector('input[name="country"]')?.value || "Unknown",
    landMark: document.querySelector('input[name="landMark"]')?.value || "",
    pincode: document.querySelector('input[name="pincode"]')?.value || "",
    phone: document.querySelector('input[name="phone"]')?.value || "",
    email: document.querySelector('input[name="email"]').value,
    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value || "COD"
  };

  try {
    const res = await fetch("/placeOrder", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(orderData)
    });

    const data = await res.json();

    if (data.success) {
      alert(data.message);
      window.location.href = "/getOrderSuccesspage";
    } else {
      alert("Failed to place order");
    }
  } catch (err) {
    console.error(err);
  }
});

</script>
</body>

<%- include("../../Views/Partials/User/footerLand") %>