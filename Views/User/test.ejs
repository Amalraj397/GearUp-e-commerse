1<%- include("../../Views/Partials/User/headerLand") %>

<head>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="/User/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="/User/assets/css/style.css">
</head>

<body>
  <div class="page-wrapper">
    <main class="main">
      <div class="page-header text-center" style="background-image: url('User/assets/images/banners/2024-Chevrolet-Corvette-Z06-GT3.R-001-1440w.jpg')">
        <div class="container">
          <h1 class="page-title">Shopping Cart<span></span></h1>
        </div><!-- End .container -->
      </div><!-- End .page-header -->
      <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="#">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
          </ol>
        </div><!-- End .container -->
      </nav><!-- End .breadcrumb-nav -->

      <div class="page-content">
        <div class="cart">
          <div class="container">
            <div class="row">
              <div class="col-lg-9">
                <table class="table table-cart table-mobile">
                  <thead>
                    <tr>
                      <th>
                        <p><b>Product</b></p>
                      </th>
                      <th>
                        <p><b>Price</b></p>
                        </p>
                      </th>
                      <th>
                        <p><b>Quantity</b></p>
                      </th>
                      <th>
                        <p><b>Total</b></p>
                      </th>
                      <th>
                        <p></p>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (cart && cart.items.length > 0) { %>
                    <% cart.items.forEach(item => { %>
                    <tr class="cart-item">
                      <td class="product-col">
                        <div class="product">
                          <figure class="product-media">
                            <a href="#">
                              <img src="<%= item.productId.productImage[0] %>" alt="Product image">
                            </a>
                          </figure>
                          <h3 class="product-title">
                            <a href="#"><%= item.productId.productName %> - <%= item.variantName %> (<%= item.scale %>)</a>
                          </h3>
                        </div>
                      </td>

                      <!-- price -->
                      <td class="price-col itemSaleprice">₹<%= item.salePrice %></td>

                      <!-- quantity -->
                      <td class="quantity-col">
                        <div class="cart-product-quantity">
                          <input type="number" class="form-control cartQuantity" value ="<%= item.quantity %>" min="1" max="5" step="1" required oninput="validateQuantity(this)">
                        </div>
                      </td>

                      <!-- total for this row -->
                      <td class="total-col totalPrice">₹<%= item.totalProductprice %></td>

                      <!-- remove -->
                      <td class="remove-col">
                        <button class="btn btn-outline-dark-2 removeCart" data-product-id="<%= item.productId._id %>"
                           style="margin-left: 15px;"> Remove</button>
                      </td>
                    </tr>

                    <% }) %>
                    <% } else { %>
                    <tr>
                      <td colspan="5" class="text-center">
                        <div class="empty-cart">
                          <h2><%= emptyMessage || "Your cart is empty" %></h2>
                          <a href="/shopPage" class="btn btn-outline-primary-2 mt-3">Continue Shopping</a>
                        </div>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table><!-- End .table table-wishlist -->

                <div class="cart-bottom">
                  <div class="cart-discount">
                    <form action="#">
                      <div class="input-group">
                        <input type="text" class="form-control" required placeholder="coupon code">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
                        </div><!-- .End .input-group-append -->
                      </div><!-- End .input-group -->
                    </form>
                  </div><!-- End .cart-discount -->

                </div><!-- End .cart-bottom -->
              </div><!-- End .col-lg-9 -->
              <aside class="col-lg-3">
                <div class="summary summary-cart">
                  <h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

                  <table class="table table-summary">
                    <tbody>
                      <tr>
                        <td colspan="2">
                          <span id="shippingNote" class="<%= TotalAmount >= 1999 ? 'text-success' : 'text-decoration-line-through' %>">
                            Free Shipping on purchase above ₹1999/-
                          </span>
                        </td>
                      </tr>
                      <tr class="summary-subtotal">
                        <td>Subtotal:</td>
                        <td></td>
                      </tr><!-- End .summary-subtotal -->

                      <tr>
                        <td colspan="2">
                          <span id="shippingNote" class="<%= TotalAmount >= 1999 ? 'text-success' : 'text-decoration-line-through' %>">
                            Cash On Delivery Available.
                          </span>
                        </td>
                      </tr>

                      <tr class="summary-total">
                        <td>TotalAmount:</td>
                        <td>
                        <td></td>
                        </td>
                      </tr><!-- End .summary-total -->
                    </tbody>
                  </table><!-- End .table table-summary -->
                  <% if (cart && cart.items.length > 0) { %>
                  <a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">
                    PROCEED TO CHECKOUT
                  </a>
                  <% } else { %>
                  <a href="#" class="btn btn-outline-secondary btn-order btn-block disabled" tabindex="-1" aria-disabled="true">
                    PROCEED TO CHECKOUT
                  </a>
                  <% } %>
                  <!-- <a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a> -->
                </div><!-- End .summary -->

                <a href="/shopPage" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
              </aside><!-- End .col-lg-3 -->
            </div><!-- End .row -->
          </div><!-- End .container -->
        </div><!-- End .cart -->
      </div><!-- End .page-content -->
    </main><!-- End .main -->

  </div><!-- End .page-wrapper -->
  <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

  <!-- Mobile Menu -->
  <div class="mobile-menu-overlay"></div><!-- End .mobil-menu-overlay -->

  <!-- Plugins JS File -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/jquery.hoverIntent.min.js"></script>
  <script src="assets/js/jquery.waypoints.min.js"></script>
  <script src="assets/js/superfish.min.js"></script>
  <script src="assets/js/owl.carousel.min.js"></script>
  <script src="assets/js/bootstrap-input-spinner.js"></script>
  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
  <script src="/User/assets/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
  // function updateRowTotal(row) {
  //     const priceElement = row.querySelector(".itemSaleprice");
  //     const quantityInput = row.querySelector(".cartQuantity");
  //     const totalElement = row.querySelector(".totalPrice");

  //     const price = parseFloat(priceElement.textContent.replace("₹", "").trim());
  //     const quantity = parseInt(quantityInput.value) || 1;
  //     const total = price * quantity;

  //     totalElement.textContent = "₹" + total.toFixed(2);
  // }

  // function updateGrandTotal() {
  //   let grandTotal = 0;
  //   document.querySelectorAll(".cart-item").forEach(row => {
  //     const totalElement = row.querySelector(".totalPrice");
  //     const total = parseFloat(totalElement.textContent.replace("₹", "").trim());
  //     grandTotal += total;
  //   });
  
  //   // Update subtotal and total in summary
  //   document.querySelector(".summary-subtotal td:last-child").textContent = "₹" + grandTotal.toFixed(2);
  //   document.querySelector(".summary-total td:last-child").textContent =  grandTotal.toFixed(2);
  // }

  // function attachQuantityListeners() {
  //   document.querySelectorAll(".cart-item").forEach(row => {
  //     const quantityInput = row.querySelector(".cartQuantity");

  //     quantityInput.addEventListener("input", () => {
  //       updateRowTotal(row);
  //       updateGrandTotal();
  //     });
  //   });
  // }

// Initial calculation on page load
  // document.addEventListener("DOMContentLoaded", () => {
  //   document.querySelectorAll(".cart-item").forEach(row => updateRowTotal(row));

  //   const savedQuantity = localStorage.getItem('cartQuantity');

  // if (savedQuantity) {
  //   savedQuantity= parseInt(savedQuantity);

  //   if (isNaN(savedQuantity) || 
  //     savedQuantity < parseInt(input.min) ||
  //     savedQuantity > parseInt(input.max)) 
  //    {
  //     input.value = input.min; // reset to min if invalid
  //   } else {
  //     input.value = savedQuantity;
  //   }
  // }
  //   updateGrandTotal();
  //   attachQuantityListeners();
  // });

    // document.querySelectorAll(".removeCart").forEach(button => {
    //   button.addEventListener("click", async () => {
    //     const productId = button.getAttribute("data-product-id");

    //     // SweetAlert confirmation
    //     Swal.fire({
    //       title: "Are you sure?",
    //       text: "This item will be removed from your cart.",
    //       icon: "warning",
    //       showCancelButton: true,
    //       confirmButtonColor: "#d33",
    //       cancelButtonColor: "#3085d6",
    //       confirmButtonText: "Yes, remove it!"
    //     }).then(async (result) => {
    //       if (result.isConfirmed) {
    //         try {
    //           const response = await fetch(`/removeFromCart/${productId}`, {
    //             method: "DELETE",
    //             headers: {
    //               "Content-Type": "application/json"
    //             }
    //           });

    //           const data = await response.json();

    //           if (response.ok) {
    //             button.closest("tr").remove();
    //             // Update the cart badge
    //             document.querySelector(".cart-badge").textContent = data.cartCount;

    //             // Success alert
    //             Swal.fire("Removed!", data.message, "success");
    //           } else {
    //             Swal.fire("Error!", data.message, "error");
    //           }
    //         } catch (error) {
    //           Swal.fire("Error!", "Something went wrong.", "error");
    //         }
    //       }
    //     });
    //   });
    // });
    
  // function validateQuantity(input) {
  //   const min = parseInt(input.min);
  //   const max = parseInt(input.max);
  //   let value = parseInt(input.value);
  
  //   // If input is not a number, reset to min
  //   if (isNaN(value)) {
  //     input.value = min;
  //     return;
  //   }
  
  //   // Clamp value between min and max
  //   if (value < min) {
  //     input.value = min;
  //   } else if (value > max-1) {
  //     input.value = max;
  
  //     // Show Toast only when value exceeds max
  //     Toastify({
  //       text: `Maximum quantity is ${max}`,
  //       duration: 1500,
  //       gravity: "top",
  //       position: "right",
  //       backgroundColor: "#FF0000",
  //       stopOnFocus: true
  //     }).showToast();
  //   }
  //   localStorage.setItem('cartQuantity', input.value);
  // }
  </script>
<script>
// function updateRowTotal(row) {
//   const priceElement = row.querySelector(".itemSaleprice");
//   const quantityInput = row.querySelector(".cartQuantity");
//   const totalElement = row.querySelector(".totalPrice");

//   const price = parseFloat(priceElement.textContent.replace("₹", "").trim());
//   const quantity = parseInt(quantityInput.value) || 1;
//   const total = price * quantity;

//   totalElement.textContent = "₹" + total.toFixed(2);
// }

// function updateGrandTotal() {
//   let grandTotal = 0;
//   document.querySelectorAll(".cart-item").forEach(row => {
//     const totalElement = row.querySelector(".totalPrice");
//     const total = parseFloat(totalElement.textContent.replace("₹", "").trim());
//     grandTotal += total;
//   });

//   // Update subtotal and total in summary
//   document.querySelector(".summary-subtotal td:last-child").textContent = "₹" + grandTotal.toFixed(2);
//   document.querySelector(".summary-total td:last-child").textContent = "₹" + grandTotal.toFixed(2);
// }

// function attachQuantityListeners() {
//   document.querySelectorAll(".cart-item").forEach(row => {
//     const quantityInput = row.querySelector(".cartQuantity");

//     quantityInput.addEventListener("input", () => {
//       validateQuantity(quantityInput);
//       updateRowTotal(row);
//       updateGrandTotal();
//     });
//   });
// }

// Initial calculation on page load
// document.addEventListener("DOMContentLoaded", () => {
//   document.querySelectorAll(".cart-item").forEach(row => {
//     const quantityInput = row.querySelector(".cartQuantity");
//     let savedQuantity = localStorage.getItem("cartQuantity");

//     if (savedQuantity) {
//       savedQuantity = parseInt(savedQuantity);

//       if (
//         isNaN(savedQuantity) ||
//         savedQuantity < parseInt(quantityInput.min) ||
//         savedQuantity > parseInt(quantityInput.max)
//       ) {
//         quantityInput.value = quantityInput.min; // reset to min if invalid
//       } else {
//         quantityInput.value = savedQuantity;
//       }
//     }

//     updateRowTotal(row);
//   });

//   updateGrandTotal();
//   attachQuantityListeners();
// });

document.querySelectorAll(".removeCart").forEach(button => {
  button.addEventListener("click", async () => {
    const productId = button.getAttribute("data-product-id");

    // SweetAlert confirmation
    Swal.fire({
      title: "Are you sure?",
      text: "This item will be removed from your cart.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, remove it!"
    }).then(async result => {
      if (result.isConfirmed) {
        try {
          const response = await fetch(`/removeFromCart/${productId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json"
            }
          });

          const data = await response.json();

          if (response.ok) {
            button.closest("tr").remove();
            // Update the cart badge
            document.querySelector(".cart-badge").textContent = data.cartCount;

            // Success alert
            Swal.fire("Removed!", data.message, "success");
          } else {
            Swal.fire("Error!", data.message, "error");
          }
        } catch (error) {
          Swal.fire("Error!", "Something went wrong.", "error");
        }
      }
    });
  });
});

// function validateQuantity(inputElement) {
//   const min = parseInt(inputElement.min);
//   const max = parseInt(inputElement.max);
//   let value = parseInt(inputElement.value);

//   // If input is not a number, reset to min
//   if (isNaN(value)) {
//     inputElement.value = min;
//     return;
//   }

//   // Clamp value between min and max
//   if (value < min) {
//     inputElement.value = min;
//   } else if (value > max-1) {
//     inputElement.value = max;

//     // Show Toast only when value exceeds max
//     Toastify({
//       text: `Maximum quantity is ${max}`,
//       duration: 1500,
//       gravity: "top",
//       position: "right",
//       backgroundColor: "#FF0000",
//       stopOnFocus: true
//     }).showToast();
//   }

//   // Save to localStorage
//   // localStorage.setItem("cartQuantity", inputElement.value);
// }
//</script>

<script>
  function updateQuantityOnBackend(productId, quantity) {
  fetch("/updateCartQuantity", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ productId, quantity })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Optionally show success toast
        Toastify({ text: "Quantity updated", duration: 500 }).showToast();
      } else {
        Toastify({
          text: data.message || "Failed to update quantity",
          duration: 1500,
          gravity: "top",
          position: "right",
          backgroundColor: "#FF0000"
        }).showToast();
      }
    })
    .catch(() => {
      Toastify({
        text: "Error updating cart",
        duration: 1500,
        gravity: "top",
        position: "right",
        backgroundColor: "#FF0000"
      }).showToast();
    });
}
  function updateRowTotal(row) {
  const priceElement = row.querySelector(".itemSaleprice");
  const quantityInput = row.querySelector(".cartQuantity");
  const totalElement = row.querySelector(".totalPrice");

  const price = parseFloat(priceElement.textContent.replace("₹", "").trim());
  const quantity = parseInt(quantityInput.value) || 1;
  const total = price * quantity;

  totalElement.textContent = "₹" + total.toFixed(2);
}

function updateGrandTotal() {
  let grandTotal = 0;
  document.querySelectorAll(".cart-item").forEach(row => {
    const totalElement = row.querySelector(".totalPrice");
    const total = parseFloat(totalElement.textContent.replace("₹", "").trim());
    grandTotal += total;
  });

  // Update subtotal and total in summary
  document.querySelector(".summary-subtotal td:last-child").textContent = "₹" + grandTotal.toFixed(2);
  document.querySelector(".summary-total td:last-child").textContent = "₹" + grandTotal.toFixed(2);
}

function validateQuantity(inputElement, productId) {
  const min = parseInt(inputElement.min);
  const max = parseInt(inputElement.max);
  let value = parseInt(inputElement.value);

  // If input is not a number, reset to min
  if (isNaN(value)) {
    inputElement.value = min;
    return;
  }

  // Clamp value between min and max
  if (value < min) {
    inputElement.value = min;
  } else if (value > max-1) {
    inputElement.value = max;

    Toastify({
      text: `Maximum quantity is ${max}`,
      duration: 1500,
      gravity: "top",
      position: "right",
      backgroundColor: "#FF0000",
      stopOnFocus: true
    }).showToast();
  }

  //Update backend cart
  updateQuantityOnBackend(productId, inputElement.value);
}


function attachQuantityListeners() {
  document.querySelectorAll(".cart-item").forEach(row => {
    const quantityInput = row.querySelector(".cartQuantity");
    const productId = row.querySelector(".removeCart").dataset.productId;

    quantityInput.addEventListener("change", () => {
      validateQuantity(quantityInput, productId);
      updateRowTotal(row);
      updateGrandTotal();
    });
  });
}

// Initial calculation on page load
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".cart-item").forEach(row => updateRowTotal(row));
  updateGrandTotal();
  attachQuantityListeners();
});

</script>

</body>

<%- include("../../Views/Partials/User/footerLand") %>