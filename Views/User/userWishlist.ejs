<%- include("../../Views/Partials/User/headerLand") %>

<head>
  <link rel="stylesheet" href="/User/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="/User/assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>

<body>
  <div class="page-wrapper">
    <main class="main">
      <div class="page-header text-center" style="background-image: url('/User/assets/images/2024-Formula1-Mercedes-AMG-W15-F1-E-Performance-005-1080.jpg')">
        <div class="container">
          <h1 class="page-title">Wishlist<span></span></h1>
        </div>
      </div>

      <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="#">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page">Wishlist</li>
          </ol>
        </div>
      </nav>

      <div class="page-content">
        <div class="container">
          <table class="table table-wishlist table-mobile">
            <thead>
              <tr>
                <th><b>PRODUCT</b></th>
                <th><b>SCALE: - PRICE</b></th>
                <th></th>
                <th></th>
                <th><b>STOCK STATUS</b></th>
                <th><b>ACTION</b></th>
                <th></th>
                <th><b>X</b></th>
              </tr>
            </thead>
            <tbody>
              <% if (wishlist && wishlist.length > 0) { %>
                <% wishlist.forEach(item => { %>
                  <tr>
                    <td class="product-col">
                      <div class="product">
                        <figure class="product-media">
                          <a href="#">
                            <img src="<%= item.productId.productImage[0] %>" alt="Product_image">
                          </a>
                        </figure>
                        <h3 class="product-title">
                          <a href="#"><%= item.productId.productName %></a>
                        </h3>
                      </div>
                    </td>

                    <td class="variant-col">
                      <select
                        class="variant-select"
                        data-product-id="<%= item.productId._id %>"
                        style="padding: 5px 15px;font-size: medium;font-weight: 400;"
                      >
                        <% item.productId.variants.forEach(variant => { 
                             const price = variant.offerPrice > 0 
                               ? variant.offerPrice 
                               : variant.salePrice;
                        %>
                          <option
                            value="<%= variant.variantName %>"
                            data-scale="<%= variant.scale %>"
                            data-price="<%= price %>"
                          >
                            <%= variant.scale %> - â‚¹<%= price %>
                          </option>
                        <% }) %>
                      </select>
                    </td>

                    <td></td>
                    <td></td>

                    <td class="stock-col">
                      <span class="in-stock" style="font-size: medium;font-weight: 500;">IN-STOCK</span>
                    </td>

                    <td class="action-col">
                      <button
                        class="btn btn-block btn-outline-primary-2 add-to-cart-btn"
                        data-product-id="<%= item.productId._id %>"
                      >
                        <i class="icon-cart-plus"></i> Add to Cart
                      </button>
                    </td>

                    <td class="remove-col">
                      <button class="remove-btn" data-product-id="<%= item.productId._id %>">
                        <i class="icon-close"></i>
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td class="product-col"><span>Your wishlist is Empty!</span></td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

  <!-- Plugins JS File -->
  <script src="/User/assets/js/jquery.min.js"></script>
  <script src="/User/assets/js/bootstrap.bundle.min.js"></script>
  <script src="/User/assets/js/jquery.hoverIntent.min.js"></script>
  <script src="/User/assets/js/jquery.waypoints.min.js"></script>
  <script src="/User/assets/js/superfish.min.js"></script>
  <script src="/User/assets/js/owl.carousel.min.js"></script>
  <script src="/User/assets/js/main.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      /* ========== ADD TO CART FROM WISHLIST ========== */
      document.querySelectorAll(".add-to-cart-btn").forEach(button => {
        button.addEventListener("click", async function () {
          const productId = this.dataset.productId;
          const row = this.closest("tr");

          const select = document.querySelector(
            `.variant-select[data-product-id="${productId}"]`
          );
          if (!select) return;

          const selectedOption = select.options[select.selectedIndex];
          const variantName = selectedOption.value;
          const scale = selectedOption.dataset.scale;
          const quantity = 1; // from wishlist we always add 1

          try {
            const res = await fetch("/addToCart", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ productId, variantName, scale, quantity })
            });

            const data = await res.json();

            // âœ… NEW ITEM ADDED TO CART
            if (data.success) {
              Toastify({
                text: data.message || "Moved to cart ðŸ›’",
                duration: 1500,
                gravity: "top",
                position: "right",
                backgroundColor: "#28a745",
              }).showToast();

              if (row) row.remove();
              return;
            }

            // ðŸ” ALREADY IN CART -> ASK TO INCREASE QTY
            if (data.alreadyInCart) {
              const result = await Swal.fire({
                title: "Already in Cart",
                text: data.message || "This item is already in your cart. Do you want to increase the quantity?",
                icon: "info",
                showCancelButton: true,
                confirmButtonText: "Yes, increase quantity",
                cancelButtonText: "Cancel"
              });

              if (result.isConfirmed) {
                const res2 = await fetch("/increaseCartQuantity", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ productId, variantName, scale, quantity })
                });

                const updateData = await res2.json();

                if (updateData.success) {
                  Toastify({
                    text: updateData.message || "Quantity updated!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#28a745",
                  }).showToast();

                  if (row) row.remove();   // âœ… remove from wishlist after qty update
                } else {
                  Toastify({
                    text: updateData.message || "Failed to update quantity",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                  }).showToast();
                }
              }

              return;
            }

            // âŒ ANY OTHER FAILURE
            Toastify({
              text: data.message || "Failed to add to cart",
              duration: 2000,
              gravity: "top",
              position: "right",
              backgroundColor: "#dc3545",
            }).showToast();

          } catch (err) {
            console.error("Wishlist addToCart error:", err);
            Toastify({
              text: "Something went wrong. Please try again.",
              duration: 2000,
              gravity: "top",
              position: "right",
              backgroundColor: "#dc3545",
            }).showToast();
          }
        });
      });

      /* ========== REMOVE FROM WISHLIST ONLY ========== */
      document.querySelectorAll(".remove-btn").forEach(button => {
        button.addEventListener("click", async function () {
          const productId = this.getAttribute("data-product-id");
          const row = this.closest("tr");

          Swal.fire({
            title: "Are you sure?",
            text: "This item will be removed from your wishlist.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, remove it!"
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                const response = await fetch(`/removeFromWishlist/${productId}`, {
                  method: "DELETE",
                  headers: { "Content-Type": "application/json" }
                });

                const data = await response.json();

                if (response.ok) {
                  if (row) row.remove();

                  if (document.querySelector(".wishlist-badge")) {
                    document.querySelector(".wishlist-badge").textContent = data.wishlistCount;
                  }

                  Toastify({
                    text: data.message || "Removed from wishlist",
                    duration: 1500,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#28a745",
                    stopOnFocus: true
                  }).showToast();

                } else {
                  Toastify({
                    text: data.message || "Failed to remove",
                    duration: 1500,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                  }).showToast();
                }
              } catch (error) {
                console.error("Wishlist remove error:", error);
                Toastify({
                  text: "Something went wrong. Please try again.",
                  duration: 1500,
                  gravity: "top",
                  position: "right",
                  backgroundColor: "#dc3545",
                  stopOnFocus: true
                }).showToast();
              }
            }
          });
        });
      });

    });
  </script>
</body>

<%- include("../../Views/Partials/User/footerLand") %>
