<%- include("../../Views/Partials/User/headerLand") %>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f5f5f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }

  .header-section {
    background: linear-gradient(135deg, #666 0%, #888 100%);
    color: white;
    padding: 60px 0;
    text-align: center;
    margin-bottom: 0;
  }

  .header-section h1 {
    font-size: 2.5rem;
    font-weight: 300;
    letter-spacing: 3px;
    margin: 0;
  }

  .breadcrumb-section {
    padding: 30px 0;
    border-bottom: 1px solid #ddd;
  }

  .breadcrumb {
    background: none;
    margin: 0;
    padding: 0;
  }

  .breadcrumb-item a {
    color: #666;
    text-decoration: none;
  }

  .breadcrumb-item.active {
    color: #333;
  }

  .main-container {
    background-color: white;
    margin: 30px auto;
    max-width: 1350px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .controls-section {
    background-color: #f8f9fa;
    padding: 25px;
    border-bottom: 1px solid #dee2e6;
  }

  .search-btn {
    border: 1px solid #c7b2b2;
    padding: 8px 18px !important;
  }

  .filter-section {
    background-color: white;
    border: 1px solid #c7b2b2;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
  }

  .filter-title {
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
  }

  .filter-group {
    margin-bottom: 15px;
  }

  .filter-group label {
    font-weight: normal;
    margin-left: 8px;
    cursor: pointer;
  }

  .sort-section select {
    border: 1px solid #c7b2b2;
    margin-top: 5px;
    border-radius: 5px;
    padding: 14px 30px;
    background-color: white;
  }

  .orders-table {
    margin: 0;
  }

  .table-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
  }

  .table-header th {
    font-weight: 600;
    color: #495057;
    padding: 20px 15px;
    border: none;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .order-row {
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
  }

  .order-row:hover {
    background-color: #f8f9fa;
  }

  .order-row td {
    padding: 20px 15px;
    vertical-align: middle;
    border: none;
  }

  .product-image {
    width: 60px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #eee;
  }

  .product-name {
    font-weight: 500;
    color: #333;
    font-size: 14px;
    line-height: 1.4;
  }

  .order-date {
    color: #666;
    font-size: 13px;
  }

  .order-price {
    font-weight: 600;
    color: #333;
    font-size: 15px;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-delivered {
    background-color: #d4edda;
    color: #155724;
  }

  .status-returned {
    background-color: #afe2ba;
    color: rgb(87, 168, 11);
  }

  .status-pending {
    background-color: #ebe06d;
    color: #44433b;
  }

  .status-shipped {
    background-color: #c2d8d5;
    color: #075d52;
  }

  .status-not-delivered {
    background-color: #f8d7da;
    color: #721c24;
  }

  .status-cancelled {
    background-color: #e99ea6;
    color: #ff0019;
  }

  .status-refund-completed {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .status-out-for-delivery {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-on-the-way {
    background-color: #cce5ff;
    color: #004085;
  }

  .status-return-accepted {
    background-color: #bee6c2;
    color: #048347;

  }

  .status-return-rejected {
    background-color: #e99ea6;
    color: #ff0019;
  }

  .reject-reason-modal {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 18px rgba(0, 0, 0, 0.15);
  }

  .reject-reason-modal .modal-header {
    background-color: #ffeaea;
    color: #b30000;
    border-bottom: none;
    font-weight: 600;
  }

  .reject-reason-modal .modal-title {
    display: flex;
    align-items: center;
    font-family: 'Poppins', sans-serif;
    font-size: 18px;
  }

  .reject-reason-text {
    /* font-family: 'Poppins', sans-serif; */
    font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
    font-size: 18px;
    color: #333;
    background-color: #fff5f5;
    border-left: 4px solid #ff4b4b;
    padding: 12px 15px;
    border-radius: 8px;
    line-height: 1.6;
    letter-spacing: 0.3px;
    margin: 8px 0;
    word-break: break-word;
  }

  .reject-reason-modal .btn-secondary {
    background-color: #ff4b4b;
    border: none;
    font-weight: 500;
  }

  .reject-reason-modal .btn-secondary:hover {
    background-color: #037786;
  }

  .btn-view {
    background-color: #1261b6;
    display: flex;
    justify-content: center;
    color: white;
    border: none;
    padding: 6px 30px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .btn-view:hover {
    background-color: #007bff;
    color: black;
  }

  .btn-cancel {
    background-color: #a32f3a;
    color: white;
    font-weight: 600;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .btn-cancel:hover {
    background-color: #fc0019;
  }

  .btn-return {
    background-color: #ffd901;
    color: rgb(32, 30, 30);
    border: none;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .btn-return:hover {
    background-color: #f8fc05;
  }

  .btn-cancel:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
  }

  .no-orders {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .no-orders i {
    font-size: 48px;
    margin-bottom: 20px;
    color: #ccc;
  }

  /* Extra orientation tweaks */
  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 6px;
    /* space between stacked buttons */
  }

  .filter-section .filter-group {
    display: flex;
    align-items: center;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 20px 0;
    font-family: "Poppins", sans-serif;
  }

  .pagination-btn,
  .page-number {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    background: #f3f3f3;
    color: #333;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .pagination-btn i {
    font-size: 12px;
  }

  .page-number {
    background: #fff;
  }

  .page-number.active {
    background: #ff6600;
    /* highlight active page */
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(255, 102, 0, 0.4);
  }

  .pagination-btn:hover,
  .page-number:hover {
    background: #ff6600;
    color: #fff;
    transform: translateY(-2px);
  }

  .pagination-btn:disabled {
    background: #ddd;
    color: #999;
    cursor: not-allowed;
    box-shadow: none;
  }

  .order-row {
    border-bottom: 2px solid #000;
    /* strong separator between orders */
  }

  .btn-more-reason {
    background: none;
    border: none;
    color: #0d6efd;
    /* Bootstrap primary blue */
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    margin-left: 6px;
    /* padding: 2px 6px; */
    border-radius: 4px;
    transition: all 0.2s ease-in-out;
  }

  .btn-more-reason:hover {
    background-color: rgba(29, 97, 200, 0.1);
    /* light blue hover */
    text-decoration: underline;
  }

  /*----------paymentStatus--------*/
  .payment-badge {
    padding: 6px 15px;
    border-radius: 18px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
  }

  /* Status Colors */
  .payment-success {
    background-color: #7ec28eff;
    color: #06641cff;
  }

  .payment-failed {
    background-color: #e9b9bdff;
    color: #ff0b23ff;
  }

  .payment-pending {
    background-color: #fff3cd;
    color: #856404;
  }

  .payment-refunded {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .payment-processing {
    background-color: #e2e3ff;
    color: #3a3ab8;
  }

  .payment-unknown {
    background-color: #e0e0e0;
    color: #333;
  }

  /*-----------retrypayemt--------------*/

  .btn-retry {
    background-color: #e99191ff;
    border:1px solid red;
    color: #ff1500ff;
    font-weight:600;
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.2s ease-in-out;
  }

  .btn-retry:hover {
    background-color: #ff1500ff;
    color: white;
    transform: scale(1.05);
  }

  .btn-retry:active {
    transform: scale(0.95);
  }

  /*---------------------------------*/

  @media (max-width: 768px) {
    .header-section h1 {
      font-size: 2rem;
      letter-spacing: 2px;
    }

    .main-container {
      margin: 15px;
      border-radius: 0;
    }

    .controls-section {
      padding: 15px;
    }

    .table-responsive {
      font-size: 13px;
    }

    .action-buttons {
      flex-direction: column;
    }
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<link rel="stylesheet" href="/User/assets/css/style.css">
</head>

<body>
  <div class="page-header text-center" style="background-image: url('/User/assets/images/2024-Formula1-Mercedes-AMG-W15-F1-E-Performance-005-1080.jpg')">
    <div class="container">
      <h1 class="page-title">My Orders<span></span></h1>
    </div><!-- End .container -->
  </div><!-- End .page-header -->

  <div class="breadcrumb-section">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/userDashboard">Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">My Orders</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="row">
      <div class="w-100 d-flex justify-content-center py-4">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search products...." value="">
          <button type="submit" class="search-btn">
            <i class="fas fa-search"></i>
          </button>
        </div>

        <div class="sort-section">
          <select id="sortSelect" class="form-select w-100">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="price-desc">Price (High to Low)</option>
            <option value="price-asc">Price (Low to High)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="d-flex">

      <!-- Orders Table -->
      <div class="table-responsive w-100 px-3">
        <table class="table orders-table">
          <thead class="table-header">
            <tr>
              <th><b>Sl 9539NO:</b></th>
              <th><b>Img</b></th>
              <th><b>Name</b></th>
              <th><b>Date of Purchase</b></th>
              <th><b>Total-Qnty</b></th>
              <th><b>Price</b></th>
              <th><b>Payment-Status</b></th>
              <th><b>Order-Status</b></th>
              <th><b>Action</b></th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- return rejection modal -->
    <div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content reject-reason-modal">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-circle text-danger me-2"></i>
              Why your Return request rejected?
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <p id="rejectReasonText" class="reject-reason-text"></p>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Orders Message -->
    <div id="noOrdersMessage" class="no-orders" style="display: none;">
      <i class="fas fa-shopping-cart"></i>
      <h4>No orders found</h4>
      <p>Try adjusting your search or filter criteria</p>
      <a href="/shopPage" class="btn btn-outline-primary-2 mt-3">Continue Shopping</a>
    </div>
    <div class="pagination">
      <button id="prev-page" class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> Previous</button>
      <div id="page-numbers" class="page-numbers">
        <button class="page-number active">1</button>
        <button class="page-number">2</button>
        <button class="page-number">3</button>
      </div>
      <button id="next-page" class="pagination-btn">Next <i class="fas fa-chevron-right"></i></button>
    </div>
  </div>

  <!--Order Return Modal -->
  <div class="modal fade" id="returnModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Return Products</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="returnForm">
            <div id="returnItemsContainer"></div>
            <div class="mb-3">
              <label class="form-label">Reason for Return</label>
              <textarea id="returnReason" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-danger w-100">Submit Return</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


  <script>
    const userOrders = <%- JSON.stringify(userOrders) %>;

    document.addEventListener("DOMContentLoaded", function() {
      // Pagination variables
      let currentPage = 1;
      const ordersPerPage = 4;
      let filteredOrders = [...userOrders];

      // Format Date
      function formatDate(dateString) {
        const options = {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        };
        return new Date(dateString).toLocaleDateString('en-US', options);
      }

      function getStatusBadge(status, rejectReason = "", orderId = "", itemId = "") {
        const statusMap = {
          'Pending': {
            class: 'status-pending',
            text: 'Pending'
          },
          'Shipped': {
            class: 'status-shipped',
            text: 'Shipped'
          },
          'Delivered': {
            class: 'status-delivered',
            text: 'Delivered'
          },
          'Cancelled': {
            class: 'status-cancelled',
            text: 'Cancelled'
          },
          'Returned': {
            class: 'status-returned',
            text: 'Returned'
          },
          'Return-accepted': {
            class: 'status-return-accepted',
            text: 'Return Accepted'
          },
          'Return-rejected': {
            class: 'status-return-rejected',
            text: 'Return Rejected'
          },
        };

        const s = statusMap[status] || {
          class: 'status-unknown',
          text: 'Unknown'
        };

        // special handling for rejected
        if (status === 'Return-rejected') {
          return `
    <span class="status-badge ${s.class}">${s.text}</span>
    <button 
      class="btn-more-reason"
      onclick="showRejectReason('${rejectReason || "No reason provided"}')"> why?
    </button>
  `;
        }

        return `<span class="status-badge ${s.class}">${s.text}</span>`;
      }

      function getPaymentBadge(paymentStatus) {
        const paymentMap = {
          "Completed": {
            class: "payment-success",
            text: "Completed"
          },
          "Failed": {
            class: "payment-failed",
            text: "Failed"
          },
          "Pending": {
            class: "payment-pending",
            text: "Pending"
          },
          "Refunded": {
            class: "payment-refunded",
            text: "Refunded"
          },
          "Processing": {
            class: "payment-processing",
            text: "Processing"
          },
        };

        const info = paymentMap[paymentStatus] || {
          class: "payment-unknown",
          text: paymentStatus
        };
        return `<span class="payment-badge ${info.class}">${info.text}</span>`;
      }

      function getActionButtons(status, orderId, paymentStatus) {
        const viewBtn = `<a href="/orderdetails/${orderId}" class="btn-view">View</a>`;

        if (paymentStatus === "Failed") {
          return `
      <div class="action-buttons">
        ${viewBtn}
        <button class="btn-retry" onclick="retryFromOrders('${orderId}')">Retry Payment</button>
      </div>
    `;
        }

        if (status === "Pending" || status === "Shipped") {
          return `
      <div class="action-buttons">
        ${viewBtn}
        <button class="btn-cancel" onclick="cancelOrder('${orderId}')">Cancel</button>
      </div>
    `;
        }

        if (status === "Delivered") {
          return `
      <div class="action-buttons">
        ${viewBtn}
        <button class="btn-return" onclick="returnOrder('${orderId}')">Return</button>
      </div>
    `;
        }

        if (status === "Cancelled") {
          return `
      <div class="action-buttons">
        ${viewBtn}
      </div>
    `;
        }

        return `<div class="action-buttons">${viewBtn}</div>`;
      }


      function renderOrders() {
        const tbody = document.getElementById('ordersTableBody');
        const noOrders = document.getElementById('noOrdersMessage');

        if (!filteredOrders.length) {
          tbody.innerHTML = '';
          noOrders.style.display = 'block';
          return;
        }

        const startIndex = (currentPage - 1) * ordersPerPage;
        const endIndex = startIndex + ordersPerPage;
        const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

        noOrders.style.display = 'none';

        // render each order and its items
        tbody.innerHTML = paginatedOrders
          .map((order, orderIndex) => {
            const slNo = startIndex + orderIndex + 1;

            // render all items of this order
            const itemRows = order.items
              .map((item, itemIndex) => {
                const product = item?.productId;
                const image = product?.productImage?.[0] || "/images/no-image.png";
                const name = product?.productName || "Unknown Product";

                return `
            <tr>
              <td>${itemIndex === 0 ? slNo : ""}</td>
              <td><img src="${image}" class="product-image" alt="${name}"></td> 
              <td>${ item.variantName.slice(0, 20)} - ${item.scale}</td>
              <td>${formatDate(order.createdAt)}</td>
              <td>${item.quantity}</td>
              <td>â‚¹${item.totalProductprice.toFixed(2)}</td>
              <td>${getPaymentBadge(order.paymentStatus)}</td>
              <td>${getStatusBadge(item.itemStatus, item.rejectReason, order._id, item._id)}</td>
              <td>
                ${itemIndex === 0 
                  ? getActionButtons(order.orderStatus, order._id,order.paymentStatus) 
                  : "" }
              </td>
              </tr> `;
              })
              .join("");

            return itemRows;
          })
          .join("");

        updatePagination();
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
        const pageNumbers = document.getElementById("page-numbers");
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");

        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;

        pageNumbers.innerHTML = "";

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4) {
          startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.className = `page-number ${i === currentPage ? "active" : ""}`;
          btn.textContent = i;
          btn.addEventListener("click", () => {
            currentPage = i;
            renderOrders();
          });
          pageNumbers.appendChild(btn);
        }
      }

      document.getElementById("prev-page").addEventListener("click", function() {
        if (currentPage > 1) {
          currentPage--;
          renderOrders();
        }
      });
      document.getElementById("next-page").addEventListener("click", function() {
        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderOrders();
        }
      });

      function handleSearch() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        filteredOrders = userOrders.filter(order => {
          const productName = order.items[0]?.productId?.productName?.toLowerCase() || "";
          return productName.includes(query);
        });
        currentPage = 1;
        renderOrders();
      }

      function handleSort() {
        const sortValue = document.getElementById("sortSelect").value;
        filteredOrders.sort((a, b) => {
          if (sortValue === "date-desc") return new Date(b.createdAt) - new Date(a.createdAt);
          if (sortValue === "date-asc") return new Date(a.createdAt) - new Date(b.createdAt);
          if (sortValue === "price-desc") return b.grandTotalprice - a.grandTotalprice;
          if (sortValue === "price-asc") return a.grandTotalprice - b.grandTotalprice;
        });
        currentPage = 1;
        renderOrders();
      }

      document.getElementById("searchInput").addEventListener("input", handleSearch);
      document.getElementById("sortSelect").addEventListener("change", handleSort);

      renderOrders();
    });

    function showRejectReason(reason) {
      document.getElementById("rejectReasonText").textContent = reason;
      const modal = new bootstrap.Modal(document.getElementById("rejectReasonModal"));
      modal.show();
    }

    async function retryFromOrders(orderId) {
  try {
  
    Swal.fire({
      title: "Redirecting to payment...",
      text: "Please wait",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const res = await fetch("/payment/retry-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId })
    });

    const data = await res.json();
    Swal.close();

    if (!data.success) {
      return Swal.fire("Error", "Unable to retry payment", "error");
    }

    const options = {
      key: data.key,
      amount: data.amount,
      currency: data.currency,
      name: "AutoMinima",
      description: "Retry Payment",
      order_id: data.orderId,

      handler: async function (response) {
        const verifyRes = await fetch("/payment/verify-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            paymentMethod: "Online-razorpay",
            oldOrderId: orderId     
          })
        });

        const verifyData = await verifyRes.json();
        if (verifyData.success) {
          window.location.href = `/orderSuccess?orderId=${verifyData.orderId}`;
        } else {
          window.location.href = `/payment/failure?orderId=${orderId}`;
        }
      }
    };

    const rzp = new Razorpay(options);
    rzp.on("payment.failed", function () {
      window.location.href = `/payment/failure?orderId=${orderId}`;
    });

    rzp.open();

  } catch (error) {
    console.error("Retry Payment Failed:", error);
    Swal.fire("Error", "Something went wrong. Try again.", "error");
  }
}

    async function cancelOrder(orderId) {
      Swal.fire({
        title: `Are you sure want to Cancel order?`,
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, cancel it",
        cancelButtonText: "No, keep it",
        reverseButtons: true
      }).then(async (result) => {
        if (result.isConfirmed) {

          Swal.fire({
            title: "Processing...",
            text: "Cancelling your order",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });

          try {
            const res = await fetch(`/orders/cancel/${orderId}`, {
              method: "PUT",
              body: JSON.stringify({
                orderId
              }),
              headers: {
                'Content-Type': 'application/json'
              }
            });
            const data = await res.json();

            Swal.close(); 

            Toastify({
              text: "Order cancelled successfully ",
              duration: 3000,
              gravity: "top",
              position: "right",
              backgroundColor: "#f56565",
              stopOnFocus: true
            }).showToast();

            setTimeout(() => location.reload(), 1000);

          } catch (err) {
            Swal.close();
            console.error(err);
            Swal.fire("Error", "Something went wrong!", "error");
          }
        }
      });
    }

    async function returnOrder(orderId) {
      const order = userOrders.find(o => o._id === orderId);
      if (!order) return;

      const container = document.getElementById("returnItemsContainer");
      container.innerHTML = order.items.map(item => `
    <div class="form-check mb-2">
      <input class="form-check-input return-item" type="checkbox"
        data-product-id="${item.productId._id}"
        data-variant="${item.variantName}"
        data-scale="${item.scale}"
        data-saleprice="${item.salePrice}"
        data-qty="${item.quantity}">
      <label class="form-check-label">
        ${item.productId.productName} (${item.variantName}, Scale: ${item.scale}) - Qty: ${item.quantity}
      </label>
    </div>
  `).join("");

      const modal = new bootstrap.Modal(document.getElementById("returnModal"));
      modal.show();

      document.getElementById("returnForm").onsubmit = async (e) => {
        e.preventDefault();

        const reason = document.getElementById("returnReason").value.trim();
        const selectedItems = [...document.querySelectorAll(".return-item:checked")].map(el => ({
          productId: el.dataset.productId,
          variantName: el.dataset.variant,
          scale: el.dataset.scale,
          quantity: Number(el.dataset.qty),
          salePrice: Number(el.dataset.saleprice),
          totalProductprice: Number(el.dataset.saleprice) * Number(el.dataset.qty)
        }));

        if (!selectedItems.length) {
          Swal.fire("Error", "Please select at least one item to return!", "error");
          return;
        }

        Swal.fire({
          title: `Do you really want to return these items?`,
          text: "Make sure the items are eligible for return.",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Yes, return",
          cancelButtonText: "No, cancel",
          reverseButtons: true
        }).then(async (result) => {
          if (result.isConfirmed) {
            //  loader
            Swal.fire({
              title: "Processing...",
              text: "Submitting your return request",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });

            try {
             
              const res = await fetch(`/orders/return/${orderId}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  returnItems: selectedItems,
                  productReturnReason: reason
                })
              });

              const data = await res.json();
              Swal.close();

              if (res.ok) {
                Toastify({
                  text: "Return request submitted ",
                  duration: 1500,
                  gravity: "top",
                  position: "right",
                  backgroundColor: "#48bb78"
                }).showToast();
                modal.hide();
                setTimeout(() => location.reload(), 1000);
              } else {
                Swal.fire("Error", data.message || "Something went wrong!", "error");
              }
            } catch (err) {
              //   hideLoader();
              Swal.close();
              console.error(err);
              Swal.fire("Error", "Server error!", "error");
            }
          }
        });
      };
    }
    
  </script>
</body>

<%- include("../../Views/Partials/User/footerLand") %>